<?xml version="1.0" encoding="ISO-8859-1"?>

<project basedir="." default="all" name="dbpatcher">

	<property file="build.properties"/>

	<path id="buildpath">
		<fileset dir="lib" includes="*.jar"/>
	</path>
	
	<mkdir dir="work"/>
	<mkdir dir="dist"/>

	<target name="all" depends="jar" description="Builds everything"/>

	<target name="rebuild" depends="clean,all" description="Rebuilds all"/>

	<target name="classes">
		<echo message="java.home=${java.home}"/>
		<mkdir dir="work/classes"/>
		<javac optimize="true" debug="true" deprecation="true" srcdir="src" destdir="work/classes">
			<classpath refid="buildpath"/>
		</javac>
	</target>

	<target name="extractjars">
		<mkdir dir="work/classes"/>
		<unjar dest="work/classes" src="lib/cmg-pas.jar"/>
		<delete dir="work/classes/com/cmg/pas/servlet"/>
		<delete dir="work/classes/com/cmg/pas/mvc"/>
		<delete dir="work/classes/com/cmg/pas/dao"/>
		<delete dir="work/classes/com/cmg/pas/email"/>
		<delete dir="work/classes/com/cmg/pas/view"/>
		<unjar dest="work/classes" src="lib/commons-collections-3.1.jar">
			<patternset>
				<include name="org/apache/commons/collections/MultiMap.class"/>
				<include name="org/apache/commons/collections/MultiHashMap*.class"/>
			</patternset>
		</unjar>
<!--		<unjar dest="work/classes" src="derby-10.1.2.1.jar"/>
		<unjar dest="work/classes" src="ojdbc14_g.jar"/> -->
	</target>

	<target name="jar" depends="classes,extractjars" description="Create jar">
		<jar destfile="dist/dbpatcher.jar" compress="true">
			<fileset dir="work/classes" includes="**/*.class"/>
			<fileset dir="src" includes="**/*.sql,**/*.properties"/>
			<manifest>
				<attribute name="Main-Class" value="ronnie.dbpatcher.Boot"/>
<!--				<attribute name="Class-Path" value="cmg-pas.jar commons-collections-3.1.jar derby-10.1.2.1.jar ojdbc14_g.jar"/> -->
			</manifest>
		</jar>
<!--		<java jar="lib/proguard-3.6.jar" fork="true">
			<arg value="@proguard.pro"/>
		</java>-->
	</target>
	
	<target name="dist" depends="rebuild">
		<copy todir="dist" preservelastmodified="true">
			<fileset dir="lib" includes="derby-*.jar,ojdbc*_g.jar"/>
			<fileset dir="" includes="dbpatcher.properties"/>
		</copy>
	</target>

	<target name="clean" description="Cleans everything">
		<delete includeEmptyDirs="true">
			<fileset dir="work" includes="**/*"/>
			<fileset dir="dist" includes="*.jar"/>
		</delete>
	</target>
	
	<target name="removedb">
		<delete dir="derbyDB"/>
	</target>

</project>
