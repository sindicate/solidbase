<?xml version="1.0" encoding="ISO-8859-1"?>

<project basedir="." name="dbpatcher">

	<property file="build.properties"/>
	<property name="version.properties" value="src/ronnie/dbpatcher/version.properties"/>

	<path id="compile.classpath">
		<fileset dir="lib" includes="*.jar"/>
	</path>
	
	<mkdir dir="work"/>
	<mkdir dir="dist"/>

	<target name="clean" description="Cleans everything">
		<delete includeEmptyDirs="true">
			<fileset dir="work" includes="**/*"/>
			<fileset dir="dist" includes="*.jar"/>
		</delete>
		<delete dir="/projects/temp/dbpatcher/db"/>
	</target>
	
	<target name="classes">
		<echo message="java.home=${java.home}"/>
		<mkdir dir="work/classes"/>
		<javac optimize="true" debug="true" deprecation="true" srcdir="src" destdir="work/classes">
			<classpath refid="compile.classpath"/>
		</javac>
	</target>

	<target name="extractjars">
		<mkdir dir="work/classes"/>
		<unjar dest="work/classes">
			<fileset file="lib/idt-commons-*.jar"/>
			<patternset>
				<exclude name="com/logicacmg/idt/commons/cache/**"/>
				<exclude name="com/logicacmg/idt/commons/email/**"/>
				<exclude name="com/logicacmg/idt/commons/jdbc/**"/>
				<exclude name="com/logicacmg/idt/commons/business/**"/>
				<exclude name="com/logicacmg/idt/commons/servlet/**"/>
				<exclude name="com/logicacmg/idt/commons/spring/**"/>
				<exclude name="com/logicacmg/idt/commons/tomcat5/**"/>
				<exclude name="com/logicacmg/idt/commons/xml/**"/>
			</patternset>
		</unjar>
		<unjar dest="work/classes">
			<fileset file="lib/commons-collections-*.jar"/>
			<patternset>
				<include name="org/apache/commons/collections/Factory.class"/>
				<include name="org/apache/commons/collections/FunctorException.class"/>
				<include name="org/apache/commons/collections/MultiMap.class"/>
				<include name="org/apache/commons/collections/map/AbstractMapDecorator.class"/>
				<include name="org/apache/commons/collections/map/MultiValueMap*.class"/>
			</patternset>
		</unjar>
	</target>

	<target name="jar" depends="classes,extractjars" description="Create jar">
		<jar destfile="dist/dbpatcher.jar" compress="true">
			<fileset dir="work/classes" includes="**/*.class"/>
			<fileset dir="src" includes="**/*.sql,**/*.properties"/>
			<manifest>
				<attribute name="Main-Class" value="ronnie.dbpatcher.Boot"/>
				<attribute name="Version" value="${module.version}"/>
			</manifest>
		</jar>
		<!--
		<java jar="lib/proguard-3.6.jar" fork="true">
			<arg value="@proguard.pro"/>
		</java>
		-->
	</target>
	
	<target name="build" depends="jar">
		<copy todir="dist" preservelastmodified="true">
			<fileset dir="lib" includes="derby-*.jar,ojdbc*.jar"/>
			<fileset dir="" includes="dbpatcher.properties,dbpatch.sql"/>
		</copy>
	</target>

	<target name="dist" depends="clean,updateversion,build"/>

	<target name="javadoc" depends="classes" description="Generate Javadoc">
		<mkdir dir="dist/docs/api"/>
		<javadoc sourcepath="src" destdir="dist/docs/api" packagenames="*" linkoffline="http://java.sun.com/j2se/1.5.0/docs/api doc/jdk1.5.0">
			<classpath refid="compile.classpath"/>
		</javadoc>
	</target>

	<target name="updateversion">
		<!-- Revert the version.properties to prevent an M from being appended to the revision number. -->
		<exec executable="svn" dir="${basedir}"><arg line="revert ${version.properties}"/></exec>
		<!-- Update the properties file. -->
		<exec executable="svnversion" dir="${basedir}" output="${version.properties}"><arg line="-n ."/></exec>
		<!-- svnversion return either format nnnn:vvvv or vvvv, we just use the vvvv part. This part can have a trailing M or S for modified or switched. -->
		<replaceregexp file="${version.properties}" match="^(|[0-9]*:)([0-9]*[M|S]*)$" replace="module.version=1.0.\2" byline="false"/>
		<loadproperties srcFile="${version.properties}"/>
		<echo message="Version: ${module.version}"/>
	</target>
	
</project>
